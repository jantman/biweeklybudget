name: Run Tox Suite
on:
  pull_request:
  push:
    branches:
      - master
  workflow_dispatch:
jobs:
  py310:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    env:
      DB_CONNSTRING: 'mysql+pymysql://root:dbroot@127.0.0.1:13306/budgettest?charset=utf8mb4'
      MYSQL_HOST: 127.0.0.1
      MYSQL_PORT: '13306'
      MYSQL_USER: root
      MYSQL_PASS: dbroot
      MYSQL_DBNAME: budgettest
      MYSQL_DBNAME_LEFT: alembicLeft
      MYSQL_DBNAME_RIGHT: alembicRight
    services:
      mariadb:
        image: 'mariadb:10.4.7'
        ports:
          - 13306:3306
        env:
          MYSQL_ROOT_PASSWORD: dbroot
          MYSQL_ROOT_HOST: '%'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install tox pymysql
      - name: Setup test DB
        run: python dev/setup_test_db.py
      - name: Create results directory
        run: mkdir -p results
      - name: Run tests
        run: tox -e ${{ github.job }}
      - name: Archive test results and artifacts
        uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: test-results-and-coverage-${{ github.job }}
          if-no-files-found: ignore
          path: |
            results/
            coverage.xml
            htmlcov/
  docs:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install tox
      - name: Run tests
        run: tox -e ${{ github.job }}
  jsdoc:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install tox && npm install -g jsdoc
      - name: Run tests
        run: tox -e ${{ github.job }}
  screenshots:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    env:
      DB_CONNSTRING: 'mysql+pymysql://root:dbroot@127.0.0.1:13306/budgettest?charset=utf8mb4'
      MYSQL_HOST: 127.0.0.1
      MYSQL_PORT: '13306'
      MYSQL_USER: root
      MYSQL_PASS: dbroot
      MYSQL_DBNAME: budgettest
      MYSQL_DBNAME_LEFT: alembicLeft
      MYSQL_DBNAME_RIGHT: alembicRight
    services:
      mariadb:
        image: 'mariadb:10.4.7'
        ports:
          - 13306:3306
        env:
          MYSQL_ROOT_PASSWORD: dbroot
          MYSQL_ROOT_HOST: '%'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install tox pymysql
      - name: Setup test DB
        run: python dev/setup_test_db.py
      - name: Run tests
        run: tox -e ${{ github.job }}
  acceptance:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    env:
      DB_CONNSTRING: 'mysql+pymysql://root:dbroot@127.0.0.1:13306/budgettest?charset=utf8mb4'
      MYSQL_HOST: 127.0.0.1
      MYSQL_PORT: '13306'
      MYSQL_USER: root
      MYSQL_PASS: dbroot
      MYSQL_DBNAME: budgettest
      MYSQL_DBNAME_LEFT: alembicLeft
      MYSQL_DBNAME_RIGHT: alembicRight
    services:
      mariadb:
        image: 'mariadb:10.4.7'
        ports:
          - 13306:3306
        env:
          MYSQL_ROOT_PASSWORD: dbroot
          MYSQL_ROOT_HOST: '%'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install tox pymysql
      - name: Setup test DB
        run: python dev/setup_test_db.py
      - name: Create results directory
        run: mkdir -p results
      - name: Run tests
        run: tox -e ${{ github.job }}
      - name: Archive test results and artifacts
        uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: test-results-and-coverage-${{ github.job }}
          if-no-files-found: ignore
          path: |
            results/
            coverage-acceptance.xml
            htmlcov-acceptance/
            .tox/acceptance/liveserver.log
  plaid:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    env:
      DB_CONNSTRING: 'mysql+pymysql://root:dbroot@127.0.0.1:13306/budgettest?charset=utf8mb4'
      MYSQL_HOST: 127.0.0.1
      MYSQL_PORT: '13306'
      MYSQL_USER: root
      MYSQL_PASS: dbroot
      MYSQL_DBNAME: budgettest
      MYSQL_DBNAME_LEFT: alembicLeft
      MYSQL_DBNAME_RIGHT: alembicRight
      PLAID_CLIENT_ID: ${{ secrets.PLAID_CLIENT_ID }}
      PLAID_COUNTRY_CODES: ${{ secrets.PLAID_COUNTRY_CODES }}
      PLAID_ENV: ${{ secrets.PLAID_ENV }}
      PLAID_PRODUCTS: ${{ secrets.PLAID_PRODUCTS }}
      PLAID_PUBLIC_KEY: ${{ secrets.PLAID_PUBLIC_KEY }}
      PLAID_SECRET: ${{ secrets.PLAID_SECRET }}
    services:
      mariadb:
        image: 'mariadb:10.4.7'
        ports:
          - 13306:3306
        env:
          MYSQL_ROOT_PASSWORD: dbroot
          MYSQL_ROOT_HOST: '%'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install tox pymysql
      - name: Setup test DB
        run: python dev/setup_test_db.py
      - name: Create results directory
        run: mkdir -p results
      - name: Run tests
        run: tox -e ${{ github.job }}
      - name: Archive test results and artifacts
        uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: test-results-and-coverage-${{ github.job }}
          if-no-files-found: ignore
          path: |
            results/
            .tox/plaid/liveserver.log
  docker:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    env:
      DB_CONNSTRING: 'mysql+pymysql://root:dbroot@127.0.0.1:13306/budgettest?charset=utf8mb4'
      MYSQL_HOST: 127.0.0.1
      MYSQL_PORT: '13306'
      MYSQL_USER: root
      MYSQL_PASS: dbroot
      MYSQL_DBNAME: budgettest
      MYSQL_DBNAME_LEFT: alembicLeft
      MYSQL_DBNAME_RIGHT: alembicRight
    services:
      mariadb:
        image: 'mariadb:10.4.7'
        ports:
          - 13306:3306
        env:
          MYSQL_ROOT_PASSWORD: dbroot
          MYSQL_ROOT_HOST: '%'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install tox pymysql
      - name: Setup test DB
        run: python dev/setup_test_db.py
      - name: Create results directory
        run: mkdir -p results
      - name: Login to Docker Hub if master branch
        if: github.ref_type == 'branch' && github.ref_name == 'master'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Run tests
        id: run-tests
        run: tox -e ${{ github.job }}
      - name: Archive test results and artifacts
        uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: test-results-and-coverage-${{ github.job }}
          if-no-files-found: ignore
          path: |
            results/
            coverage.xml
            htmlcov/
      - name: Docker Push if master
        if: github.ref_type == 'branch' && github.ref_name == 'master'
        run: |
          docker push jantman/biweeklybudget:${{ steps.run-tests.outputs.DOCKER_IMG_TAG }}
  migrations:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    env:
      DB_CONNSTRING: 'mysql+pymysql://root:dbroot@127.0.0.1:13306/budgettest?charset=utf8mb4'
      MYSQL_HOST: 127.0.0.1
      MYSQL_PORT: '13306'
      MYSQL_USER: root
      MYSQL_PASS: dbroot
      MYSQL_DBNAME: budgettest
      MYSQL_DBNAME_LEFT: alembicLeft
      MYSQL_DBNAME_RIGHT: alembicRight
    services:
      mariadb:
        image: 'mariadb:10.4.7'
        ports:
          - 13306:3306
        env:
          MYSQL_ROOT_PASSWORD: dbroot
          MYSQL_ROOT_HOST: '%'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install tox pymysql
      - name: Setup test DB
        run: python dev/setup_test_db.py
      - name: Create results directory
        run: mkdir -p results
      - name: Run tests
        run: tox -e ${{ github.job }}
      - name: Archive test results and artifacts
        uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: test-results-and-coverage-${{ github.job }}
          if-no-files-found: ignore
          path: |
            results/
            coverage.xml
            htmlcov/
  coverage:
    runs-on: ubuntu-latest
    needs: py310
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v3
      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: test-results-and-coverage-py310
      - name: Extract coverage percentage
        id: coverage
        run: |
          COVERAGE=$(python -c "
          import xml.etree.ElementTree as ET
          try:
              tree = ET.parse('coverage.xml')
              root = tree.getroot()
              coverage = root.attrib.get('line-rate', '0')
              percentage = round(float(coverage) * 100, 1)
              print(f'COVERAGE_PERCENTAGE={percentage}')
          except:
              print('COVERAGE_PERCENTAGE=0')
          " | grep COVERAGE_PERCENTAGE | cut -d= -f2)
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT

          # Generate coverage summary
          echo "## ðŸ“Š Code Coverage Report" > coverage_comment.md
          echo "" >> coverage_comment.md
          echo "**Coverage: ${COVERAGE}%**" >> coverage_comment.md
          echo "" >> coverage_comment.md

          if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
            echo "âœ… Coverage meets minimum threshold of 80%" >> coverage_comment.md
          else
            echo "âš ï¸ Coverage below minimum threshold of 80%" >> coverage_comment.md
          fi

          echo "" >> coverage_comment.md
          echo "ðŸ“ **Detailed Report**: Check the \`test-results-and-coverage-py310\` artifact for full HTML report" >> coverage_comment.md
          echo "" >> coverage_comment.md
          echo "ðŸ” **Generated by**: Unit tests (\`tox -e py310\`)" >> coverage_comment.md
      - name: Comment PR with coverage
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('coverage_comment.md', 'utf8');

            // Find existing coverage comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸ“Š Code Coverage Report')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

